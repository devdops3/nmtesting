name: .NET CI/CD Pipeline to IIS

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Restore NuGet packages
      run: msbuild -t:Restore -p:Configuration=Release /bis/website.publishproj
      working-directory: ./bis/

    - name: Build Project
      run: msbuild -p:Configuration=Release -p:DeployOnBuild=true -p:WebPublishMethod=Package -p:PackageAsSingleFile=true -p:SkipInvalidConfigurations=true -p:PackageLocation=./artifact /bis/website.publishproj
      working-directory: ./bis/

    - name: Test Project
      run: |
        # Replace with the actual command to run your tests, e.g., using dotnet test
        echo "Run your tests command here"
      working-directory: ./bis/

    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: build-artifact
        mkdir: ./artifact
        path: ./artifact

    - name: Install SSH Client
      run: |
        choco install openssh
      shell: pwsh

      #    - name: Compress Artifacts
      #      run: Compress-Archive -Path ./artifact/* -DestinationPath ./artifact/artifact.zip
      #      shell: pwsh


      #    - name: Deploy to IIS
      #      run: |
      #        $username = $env:SERVER_USERNAME
      #        $password = $env:SERVER_PASSWORD | ConvertTo-SecureString -AsPlainText -Force
      #        $credential = New-Object System.Management.Automation.PSCredential ($username, $password)
      #
      #        # Create a new SSH session
      #        $session = New-PSSession -HostName $env:SERVER_ADDRESS -UserName $username -SSHTransport
      #
      #        # Copy files to the remote IIS server
      #        Invoke-Command -Session $session -ScriptBlock {
      #          param ($srcPath, $destPath)
      #          Copy-Item -Path $srcPath -Destination $destPath -Recurse
      #        } -ArgumentList ('./build-artifact.zip', 'c:/inetpub/wwwroot/')
      #
      #        # Remove the session
      #        Remove-PSSession -Session $session
      #      shell: pwsh
      #      env:
      #        SERVER_ADDRESS: ${{ secrets.SERVER_ADDRESS }}
      #        SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
      #        SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
      #
